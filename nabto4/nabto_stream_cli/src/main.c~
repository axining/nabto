// main.c
#include "nabto_client_api.h"

#include <stdio.h> 
#include <string.h>

int main(int argc, char** argv)
{
    nabto_status_t st = nabtoStartup(NULL);
    if (st != NABTO_OK) {
        printf("初始化失败：1\n"); // handle error and stop  
    }else{
        printf("初始化成功：1\n");
    }

    nabto_handle_t session;
    st = nabtoOpenSession(&session, "8888611@163.com", "xinxin.123");
    if (st != NABTO_OK) {
        printf("初始化失败：2\n"); // handle error and stop  
    }else{
        printf("初始化成功：2\n");
    }

    //context_t* context = (context_t*)malloc(sizeof(context_t));
    //memset(context, 0, sizeof(context_t));

    nabto_stream_t stream;
    const char* host = "vbqh4jgc.aibspi.trial.nabto.net";
    st = nabtoStreamOpen(&stream, session, host);
    if (st != NABTO_OK) {
        printf("初始化失败：3\n"); // handle error and stop  
    }else{
        printf("初始化成功：3\n");
    }

    const char* message = "Hello, world!";
    st = nabtoStreamWrite(stream, message, strlen(message));
    if (st != NABTO_OK) {
        printf("初始化失败：4\n"); // handle error and stop  
    }else{
        printf("初始化成功：4\n");
    }
    
    char* response;
    size_t actual;
    st = nabtoStreamRead(stream, &response, &actual);
    if (st != NABTO_OK) {
        printf("初始化失败：5\n"); // handle error and stop  
    }else{
        printf("初始化成功：5\n");
    }

    /* use response for something */
    printf("read stream success: !\n", response);
    
    nabtoFree(response);
    nabtoStreamClose(stream);

    nabtoCloseSession(session);
    nabtoShutdown();

    return 0;
}

